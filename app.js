import { CronJob } from 'cron';
import { app, errorHandler } from 'mu';
import { createJobFromScheduledJob } from "./lib/job";
import { getRepeatFrequency, getScheduledJobData, getScheduledJobs } from './lib/scheduled-job';
import { waitForDatabase } from './utils/database-utils';

const CRON_MANAGE_SCHEDULED_JOBS = process.env.CRON_MANAGE_SCHEDULED_JOBS || '*/5 * * * *';
const CRON_JOBS = {};

waitForDatabase(manageScheduledJobs);

async function manageScheduledJobs(){
  new CronJob(CRON_MANAGE_SCHEDULED_JOBS, async function() {
    console.log(`Managing ScheduledJobs`);
    try {
      const scheduledJobs = await getScheduledJobs();
      const fetchedJobUris = scheduledJobs.map(job => job.uri);

      console.log(`Checking for obsolete ScheduledJobs to unschedule.`);
      let currentJobUris = Object.keys(CRON_JOBS);
      const obsoleteJobUris = currentJobUris.filter(x => !fetchedJobUris.includes(x));

      for(const obsoleteJobUri of obsoleteJobUris){
        console.log(`Removing ${obsoleteJobUri}`);
        await deleteScheduledJob({ uri: obsoleteJobUri });
      }

      console.log(`Checking for new ScheduledJobs to schedule.`);
      currentJobUris = Object.keys(CRON_JOBS);
      const newJobUris = fetchedJobUris.filter(x => !currentJobUris.includes(x));

      for(const newJobUri of newJobUris){
        console.log(`Adding ${newJobUri}`);
        await addScheduledJob({ uri: newJobUri });
      }

    }
    catch(e) {
      console.error(`Something unexpected went wrong while managing ScheduledJobs`);
      console.error(e);

      //TODO: alert someone
    }
  }, null, true);
}

app.get('/', function (_, res) {
  res.send('Hello from scheduled-job-controller');
});

function deleteScheduledJob(scheduledJob) {
  const cron = CRON_JOBS[scheduledJob.uri];
  if(cron) {
    cron.stop();
    delete CRON_JOBS[scheduledJob.uri];
  }
  else {
    console.warn(`No active job found for ${scheduledJob.uri}, ignoringc`);
  }
}

async function addScheduledJob(scheduledJob) {
  const repeatFrequency = await getRepeatFrequency(scheduledJob);
  scheduledJob.repeatFrequency = repeatFrequency;
  CRON_JOBS[scheduledJob.uri] = new CronJob(scheduledJob.repeatFrequency, async function() {

    try {
      console.log(`Executing scheduled job: creating new job generated by scheduled-job: ${scheduledJob.uri}`);
      const scheduledJobData = await getScheduledJobData(scheduledJob);
      await createJobFromScheduledJob(scheduledJobData);
    }

    catch(e) {
      if(!CRON_JOBS[scheduledJob.uri]){
        console.warn(`There was an error executing scheduled-job: ${scheduledJob.uri}, but this ScheduledJob was removed from this service`);
        console.warn(`This should be normal, as there is no way currently to gracefully remove a job from with the current cron library`);
        //TODO: This is not 100% bulletproof and might break if the both calls in the body of the cron change. So be careful.
      }
      else {
        console.error(`Something unexpected went wrong while executing scheduled-job: ${scheduledJob.uri}`);
        console.error(e);
        //TODO: alert someone
      }
    }

  }, null, true);
}

app.use(errorHandler);
